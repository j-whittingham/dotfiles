#!/bin/sh

# X11 Dynamic Menu
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

# ......................................................................... Edit

# update .pacnew system configs
copy=$(mktemp)
while true
do
  file=$(sudo find /etc -name '*.pacnew' | sed -e 's|^/etc/||' -e 's/.pacnew$//')
  if [[ -z $file ]]; then
    [[ -e $copy ]] && echo ".. zero (0) outstanding .pacnew files"
    break
  fi
  file=$(echo -e "$file" | $(dmenu) -p 'Merge .pacnew') || break
  if [[ $file ]]; then
    pacnew=$(sudo find /etc -wholename "/etc/$file.pacnew")
    cp -f $pacnew $copy
    current=${pacnew%.pacnew}
    echo $current
    # gvimdiff for colorscheme
    sudo gvimdiff --nofork $pacnew $current

    # use updated .pacnew
    action='keep\ndelete\nuse'
    if ! sudo cmp $pacnew $copy; then
      update=$(echo -e 'no\nyes' | $(dmenu) -p "Update $file") || continue
      if [[ $update = yes ]]; then
        sudo cp $current /tmp
        sudo mv $pacnew $current
        continue
      else
        action='restore\ndelete'
      fi
    fi

    # keep / restore / delete / use .pacnew
    while true
    do
      action=$(echo -e "$action" | $(dmenu) -p " $file.pacnew") || break
      case $action in
        restore)  sudo cp $copy $pacnew ;;
        delete)   sudo mv $pacnew /tmp ;;
        use)      sudo cp $current /tmp
                  sudo mv $pacnew $current
                  ;;
        keep)     ;;
        *)        continue ;;
      esac
      break
    done
  else
    break
  fi
done
rm -f $copy
