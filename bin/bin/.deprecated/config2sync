#!/bin/sh
# replace indirect ".config" symlinks with direct "sync" symlinks

action=$@
[ -z $action ] && action=show
if [ $action != show -a $action != apply ]; then
  echo ".config2sync show | apply"
  exit
fi

symlinks=$(ls -la | grep '[-][>]' | grep '.config' | sed 's/  */ /g' | cut -d' ' -f9- | cut -d'>' -f2- | sed 's/^ *//' | sed 's/ /?/g')
for i in $symlinks; do
  if [ "$i" != seafile ]; then
    if [ $(echo $i | sed 's/.*\.config\/.*/true/') = true ]; then
      synclink=$(ls -la $i | grep '[-][>]' | grep 'sync' | sed 's/  */ /g' | cut -d' ' -f9- | cut -d'>' -f2- | sed 's/^ *//' | sed 's/ /?/g')
      echo -n "[ $action = show ] " && echo "$i => $synclink"
      if [ -n "$synclink" ]; then
        target=$(basename $synclink)
        [ -L .$target ] && target=.$target || target=.
        newlink=$(dirname $synclink | sed -e 's/\.\.\///' -e 's/\/.config//')/$target
        case $action in
          show)   echo mv -v $(echo $synclink | sed 's/\.\.\///') $newlink
                  echo ln -sfv $newlink $target
                  echo rm -fv $i
                  echo '---'
                  read
                  ;;
          apply)  mv -v $(echo $synclink | sed 's/\.\.\///') $newlink
                  ln -sfv $newlink $target
                  rm -fv $i
                  echo '---'
                  read
                  ;;
        esac
      fi
    fi
  fi
done
