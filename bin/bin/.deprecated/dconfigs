#!/bin/sh

# X11 Dynamic Menu
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

# ......................................................................... Edit

# system conf files
configs=~/.dconfigs

dinit() {
  notify "Updating dmenu config cache" "Please be patient.."
  exclude='\.azureus|backups|\.bundler|\.cache|cairo|chromium|depot|\.deprecated|\.dropbox|geany|\.gem|\.ghc|\.gimp|google|\.kde|libreoffice|\.mozilla|\.opera|\.original|sandbox|\.save|(s|u)mplayer|tint2|Trash|\.vim|vundle|\.xbmc|\.xmonad|xfce4'

  # convert spaces in filenames to tilde and convert back after joining!
  echo $HOME/build/root/var/spool/cron/$USER \
       $(sudo find /etc -maxdepth 1 -type f | egrep -v "\.original") \
       $(sudo find /etc -type f -regex '.*cfg' | sed 's/ /~/g') \
       $(sudo find /etc -type f -regex '.*conf\(ig\)*' | egrep -v 'asciidoc|bluetooth|dbus-1|fonts|ghostscript|sane\.d' | sed 's/ /~/g') \
       $(sudo find /etc -type f -regex '.*/conf\(ig\)*.*' | egrep -v 'exim4|fonts' | sed 's/ /~/g') \
       $(sudo find /etc -type f -regex '.*ini' | sed 's/ /~/g') \
       $(sudo find /etc -type f -regex '.*rc' | egrep -v 'Muttrc' | sed 's/ /~/g') \
       $(sudo find /opt -type f -regex '.*conf\(ig\)*' | egrep -v '\.git' | sed 's/ /~/g') \
       $(sudo find /opt -type f -regex '.*ini' | sed 's/ /~/g') \
       $(sudo find /usr/lib/systemd/system/ -type f) \
       $([[ -d /var/adsuck ]] && sudo find /var/adsuck -type f | sed 's/ /~/g') \
       $(find ~ -type f -regex '.*cfg' | egrep -v "$exclude" | sed 's/ /~/g') \
       $(find ~ -type f -regex '.*conf\(ig\)*' | egrep -v "$exclude" | sed 's/ /~/g') \
       $(find ~ -type f -regex '.*/conf\(ig\)*.*' | egrep -v "$exclude" | sed 's/ /~/g') \
       $(find ~ -type f -regex '.*ini' | egrep -v "$exclude" | sed 's/ /~/g') \
       $(find ~ -type f -regex '.*rc' | egrep -v "$exclude" | sed 's/ /~/g') \
       | sed 's/ /\n/g' \
       | sed 's/~/ /g' \
       | sort \
       | uniq \
       > $configs
  notify "Updating dmenu config cache" "..Finished"
}

# command line initialization with: dconfigs [init]
[[ -s $configs || $* ]] || dinit
[[ $* ]] && exit

while true
do
  file=$(cat $configs | sed -e '1i[ rebuild database ]' | $(dlist) -p 'Edit Config') || break
  if [[ $file = '[ rebuild database ]' ]]; then
    dinit
    continue
  fi
  [[ $file ]] && eval v $file
  break
done
