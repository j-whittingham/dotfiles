#!/bin/sh

# X11 Dynamic Menu
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

# .................................................................. Alarm clock

# Usage: dalarm (interactive mode)
#        dalarm duration description
#        dalarm duration description repetitions
#
# Note:  duration defaults to minutes (not seconds)

duration() {
  # non-numeric character escapes undesired dmenu match
  echo $@ | sed -e 's/^[^0-9]//' -e 's/\([0-9]\)$/\1m/'
}

case $# in
  1)  delay=$(duration $1)
      alert=$(echo $delay | sed -e 's/\(.*\)s/\1 seconds/' -e 's/\(.*\)m/\1 minutes/')
      repeat=1
      ;;
  2)  delay=$(duration $1)
      alert=$2
      repeat=1
      ;;
  3)  delay=$(duration $1)
      alert=$2
      repeat=$3
      ;;
  *)  [[ -e ~/tmp/dalarm_t ]] && default_t=$(< ~/tmp/dalarm_t) || default_t='1m'
      [[ -e ~/tmp/dalarm_m ]] && default_m=$(< ~/tmp/dalarm_m) || default_m='Alarm'
      delay=$(echo $default_t | $(dmenu) -p 'Duration [m]/s') || exit
      [[ $delay ]] || delay=$default_t
      delay=$(duration $delay)
      echo "$delay" > ~/tmp/dalarm_t
      alert=$(echo $default_m | $(dmenu) -p 'Message') || exit
      [[ $alert ]] || alert="$default_m"
      echo "$alert" > ~/tmp/dalarm_m
      repeat=$(echo '1' | $(dmenu) -p 'Repeat') || exit
      ;;
esac

(( $repeat - 1 )) && notify "$alert" "$delay x $repeat" || notify "$alert" "$delay"

alarm() {
  for i in $(seq 1 $repeat)
  do
    sleep $delay
    if (( $repeat - 1 )); then
      (( $repeat - $i )) && time=0 notify "($i/$repeat)  $alert" || time=0 notify "($i/$repeat)  $alert" "Finished"
    else
      time=0 notify "$alert"
    fi
    paplay ~/music/sonar-ping.wav &
  done
}

# if invoked from command line..
alarm &
