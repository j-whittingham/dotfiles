#!/bin/sh

# X11 Dynamic Menu
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬

# ....................................................................... E-mail

# select email contact addresses for insert into sup query
maildir=~/Maildir
addressbook=$maildir/addressbook
# additional contacts
# - name <address>
# - tag :: name <address>,..
contacts=$maildir/contacts

# build address list
# - exclude major lists correspondence
# - exclude news and announcement items
# - exclude malformed addresses, unexpected characters
# - addresses must include "user name" prefix
dinit() {
  notify "Updating dmenu addressbook cache" "Please be patient.."
  /usr/bin/vendor_perl/ack --no-filename --ignore-case --no-color '^(From|To|Cc|Bcc):' $maildir \
    | grep '@' \
    | sed -e 's/\(\xad\|\x01\)/ /g' \
          -e 's/[,;] */\n/g' \
          -e 's/["]//g' \
          -e "s/[']//g" \
          -e 's/<br>//' \
          -e 's/<mailto:[^>]*>//' \
          -e 's/\t/ /g' \
          -e 's/  *$//' \
          -e 's/^  *//' \
          -e 's/  */ /g' \
          -e 's/^To: //I' \
          -e 's/^From: //I' \
          -e 's/^Cc: //I' \
          -e 's/^Bcc: //I' \
          -e 's/< */</' \
          -e 's/ *>/>/' \
    | grep '^[^<].*<.*>$' \
    | grep -v '@.*<' \
    | grep -iv '\(^[^a-z]\|[=]\)' \
    | grep -Piv '<comments(?!@thedarnedestthing)' \
    | grep -iv '\(\(hello\|info\)@\)' \
    | grep -iv '\(announce\|automated\|confirm\|contact\|help\|invitations\|market\|news\|notification\|promo\|reply\|review\|subscribe\|welcome\)' \
    | grep -iv '\(feedspot\|github\|via linkedin\|yahoogroups\)' \
    | sort -f | uniq -i \
    > $addressbook
  notify "Update of dmenu addressbook cache" "..Complete"
}

# command line initialization with: dabook [init]
[[ -s $addressbook || $* ]] || dinit
[[ $* ]] && exit

ribbon() {
  width=50
  if [[ -z $* ]]; then
    echo
  elif [[ $(echo $@ | wc -c) -lt $width ]]; then
    echo "   $@"
  else
    echo "   ..$(echo $@ | cut -c $(( $(echo $@ | wc -c) - $width ))-)"
  fi
}

addresslist() {
  if [[ $addresses ]]; then
    cat $contacts $addressbook \
    | sed '/^ *$/d' \
    | sed '1i[ paste ]\n[ clipboard ]\n[ add contacts ]\n[ rebuild database ]'
  else
    cat $contacts $addressbook \
    | sed '/^ *$/d'
  fi
}

while true
do
  address=$(addresslist | $(dlist) -p "Address$(ribbon $addresses)") || break
  case $address in
    '[ paste ]')              echo -n "$addresses" | xsel -i
                              xdotool type "$addresses"
                              break
                              ;;
    '[ clipboard ]')          echo -n "$addresses" | xsel -i
                              time=10000 notify "Ctrl-Alt-V" "$(echo $addresses | sed 's/ <\S*>//g')"
                              break
                              ;;
    '[ add contacts ]')       if [[ $addresses ]]; then
                                name=$($(dmenu) -noinput -p "Name") || continue
                                [[ $name ]] || name="Contacts"
                                echo "$name :: $addresses" >> $contacts
                                unset addresses
                              fi
                              ;;
    '[ rebuild database ]')   dinit
                              unset addresses
                              ;;
    *)                        address=$(echo $address | sed 's/.* :: //')
                              [[ $addresses ]] && addresses=$addresses,$address || addresses=$address
                              ;;
  esac
done
echo $addresses
