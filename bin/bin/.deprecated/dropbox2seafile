#!/bin/sh
# convert old "dropbox" symlinks to new "seafile" organization

action=$@
[ -z $action ] && action=show
if [ $action != show -a $action != apply ]; then
  echo "dropbox2seafile show | apply"
  exit
fi

symlink() {
  case $1 in
    show)   echo ln -sfv "$2" $3
            ;;
    apply)  ln -sfv "$2" $3
            ;;
  esac
}

symlinks=$(ls -la | grep '[-][>]' | grep 'Dropbox' | sed 's/  */ /g' | cut -d' ' -f9- | cut -d'>' -f2- | sed 's/^ *//' | sed 's/ /?/g')
for i in $symlinks; do
  # [ $action = show ] && echo "dirname => $(dirname $i)"
  target=$(basename $i)
  [ -f .$target ] && target=.$target || target=.
  case $i in
    Dropbox/dist/bin)   symlink $action seafile/bin $target
                        ;;
    Dropbox/.todo)      if [ -f .todo ]; then
                          rm -f .todo
                          symlink $action seafile/todo .todo
                        fi
                        ;;
    *)                  dirname=$(dirname $i)
                        case $dirname in
                          *Dropbox/dist/.config*)   symlink $action $(echo $dirname | sed 's/Dropbox\/dist/seafile\/user/')/$(basename $i) $target
                                                    ;;
                          *Dropbox/dist/.local*)    symlink $action $(echo $dirname | sed 's/Dropbox\/dist/seafile\/user/')/$(basename $i) $target
                                                    ;;
                          *)                        newlink=$(echo $i | sed 's/Dropbox/seafile/')
                                                    symlink $action $newlink $target
                                                    ;;
    esac
  esac
done
