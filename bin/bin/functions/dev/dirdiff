#!/usr/bin/bash
# sdothum - 2016 (c) wtfpl

# Dev
# ▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂

# ........................................................ Directory differences

usage() {
  echo "usage: $(basename $0) [-b] <directory> <directory> <regex>"
  exit 1
}

ignore='backups|debian|\.history|makepkg|nixos|plugged|plugged-custom|plugin|qmk_firmware|root|snippets|vps'

# ignore leading and trailing whitespace
if [ "$1" = '-b' ] ;then
  w=-w
  diffopt='set diffopt+=iwhite'
  shift
fi

[ $# -lt 2 ] && usage
[ $# -gt 3 ] && usage
[ -d $1    ] || usage
[ -d $2    ] || usage

if [ "$3" ] ;then
  regex="$3"
else
  regex='.*'
fi

# to handle filenames containing spaces
find $1 -type f | exclude | egrep -v $ignore | grep "$regex" >/tmp/dirdiff:files

while read file <&3 ;do
  unset blink
  while : ;do
    echo "${GREEN}${blink}-> $file${NOCOLOR}"
    if ! diff --color $w "$file" "$2/$file" ;then
      # see herbstluftwm gvimdiff rule
      ifno "edit $file" && break || gvimdiff -c "$diffopt" -f --role=gvimdiff "$file" "$2/$file"
      blink=${BLINK}
    else
      break
    fi
  done
done 3< /tmp/dirdiff:files

# vim: set ft=sh: #
