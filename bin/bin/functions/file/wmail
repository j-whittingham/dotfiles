#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# File
# ══════════════════════════════════════════════════════════════════════════════

# ................................................................ watchman mail

# Usage: wmail [-s]

# watchman
ROOT=$HOME/Maildir
NAME=wmail
CMD=wmail

WATCH=$CACHEDIR/$NAME
LOG=/tmp/$NAME.log
HISTORY=/tmp/$NAME:history

activity() {
  [ -s $WATCH ] || return
  timestamp >>$HISTORY  # separate watchman blocks for imap analysis
  while read file <&3 ;do
    acct=$(echo $file | sed "s|$ROOT/||")
    acct=${acct%%/*}
    imap=${file##*/}
    echo "$ROOT/$acct:${imap%:2,*}"
  done 3< $WATCH | sort -u
  cat $WATCH >>$HISTORY; >$WATCH
}

mail() {
  for i in $(activity) ;do
    acct=$(echo $i | cut -d: -f1)
    name=$(echo $i | cut -d: -f2-)
    email=$(find $acct -name "${name}*")
    [ -n "$email" ] || { ditto "wmail -> not found: $acct/$name" >>$LOG; continue; }
    hdr=$(mailheader "$email")
    notify X critical "$(echo "$hdr" | grep Subject: | sed 's/ re://g')" "$(echo "$hdr" | grep From:)"
  done
}

case $1 in
'') pgrep -f "watchman watch-project $ROOT" >/dev/null && watchman get-config $ROOT || watchd $ROOT $NAME $CMD & ;;
-s) watchman watch-del $ROOT; watchman shutdown-server; pkill -f "watchd $ROOT $NAME $CMD" ;;
* ) watchq f $ROOT $NAME $@; [ $(pgrep -cf "watchq f $ROOT $NAME") -eq 1 ] && mail & ;;  # delay for imap processing latencies
esac

# vim: set ft=sh: #
