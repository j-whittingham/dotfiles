#!/bin/zsh
# install base packages

# log output to typescript
script-check


title "setup"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
# sudo loadkeys colemak
is_server && sudo dhcpcd || sudo wifi-menu
sleep 5s
grep '^nameserver' /etc/resolv.conf || sudo sed -i '$anameserver 10.1.0.1' /etc/resolv.conf
# disable CoW on systemd journal
sudo chattr +C /var/log/journal/


title "keyserver"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
rm -rf ~/.gnupg/*
sudo rm -rf /root/.gnupg/*
sudo mkdir /root/.gnupg 2>/dev/null
sudo touch /root/.gnupg/dirmngr_ldapservers.conf
sudo dirmngr </dev/null


title "update base"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
sudo pacman -Syu
pm_install base-devel
# pm_install expac
pm_install git
pm_install gnome-keyring
# pm_install jshon
# pm_install namcap
# pm_install yajl


title "install package managers"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
cd /tmp
sudo rm -Rf package-query*
curl -O https://aur.archlinux.org/packages/pa/package-query/package-query.tar.gz
tar xzf package-query.tar.gz
cd package-query
makepkg -s
sudo pacman -U --noconfirm package-query*tar.xz

cd /tmp
sudo rm -Rf yaourt*
curl -O https://aur.archlinux.org/packages/ya/yaourt/yaourt.tar.gz
tar xzf yaourt.tar.gz
cd yaourt
makepkg -s
sudo pacman -U --noconfirm yaourt*tar.xz
yaourt -Syu


title "pacman key server"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
if grep -q 'keyserver hkp://pgp.mit.edu:11371' /etc/pacman.d/gnupg/gpg.conf; then
  original /etc/pacman.d/gnupg/gpg.conf
  # switch to non-ISP-blocked MIT server
  sudo sed -i '/^keyserver hkp:/ckeyserver hkp://pgp.mit.edu:11371' /etc/pacman.d/gnupg/gpg.conf
fi
sudo pacman -Syu haveged
sudo systemctl start haveged
sudo systemctl enable haveged


# if title_if "zfs kernel module"             "is_server"; then
# # ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
#   aur_install spl
#   aur_install spl-utils
#   aur_install zfs
#   aur_install zfs-utils
#   sudo systemctl enable zfs
#   # sudo systemctl start zfs
# fi


if title_if "cpu power management"          "is_laptop"; then
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
  pm_install cpupower
fi


title "sound"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
pm_install alsa-utils
sudo usermod -a -G audio $USER


title "shell"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
aur_install fasd
aur_install prezto-git


title "x11/video drivers"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
# if lspci | grep VGA | grep -q ATI; then
#   sudo sed -i '$a\
# [catalyst]\
# Server = http://catalyst.wirephire.com/repo/catalyst/$arch\
# Server = http://70.239.162.206/catalyst-mirror/repo/catalyst/$arch\
# Server = http://mirror.rts-informatique.fr/archlinux-catalyst/repo/catalyst/$arch' /etc/pacman.d/mirrorlist
#   sudo pacman-key --keyserver pgp.mit.edu --recv-keys 0xabed422d653c3094
#   sudo pacman-key --lsign-key 0xabed422d653c3094
#   sudo pacman -Syu
#   pm_install catalyst
#   pm_install catalyst-utils
#   pm_install lib32-catalyst-utils
# fi
lspci | grep VGA | grep -q ATI && pm_install xf86-video-ati
lspci | grep VGA | grep -q Intel && pm_install xf86-video-intel
is_laptop && pm_install xf86-input-synaptics
# x11
pm_install mesa
# aur_install mesa-git
# aur_install mesa-vdpau-git
pm_install xorg-xinit
pm_install xorg-server
pm_install xorg-server-utils


title '*replace* fontconfig and freetype2 fonts with infinality bundle'
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
# aur_install fontconfig-infinality
# yaourt -S freetype2-infinality
pm_install ibfonts-meta-base
pm_install -S cairo-infinality-ultimate
pm_install -S fontconfig-iu-comp
# pm_install -S infinality-bundle
# pm_install infinality-bundle-multilib


title "ncurses editor and terminal/font"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
pm_install gvim
pm_install ttf-inconsolata
aur_install rxvt-unicode-patched
pm rxvt-unicode-patched || aur_install rxvt-unicode-patched "sha1sum required from ~/build/archlinux/pre_install/rxvt-unicode-patched"


title "window manager"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
# pm_install herbstluftwm
aur_install herbstluftwm-git


# if title_if "arch as virtualbox guest"      "[[ -n $(dmidecode --type 1 | grep VirtualBox) ]]"; then
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
#   pm_install virtualbox-guest-utils
# fi


# title "build man pages"
# # ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
# sudo mandb


title "installation errors:"
# ▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
grep '> \(ERROR\|WARNING\)' ~/typescript
echo
echo "initialize .xinitrc and window manager configurations, then startx.."
